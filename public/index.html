<script src="/socket.io/socket.io.js"></script>

<script>
const socket = io({
  transports: ["websocket"],
  upgrade: false
});

const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");
const resultText = document.getElementById("result");

let peer;
let localStream;
let makingOffer = false;
let ignoreOffer = false;

const config = {
  iceServers: [
    { urls: "stun:stun.l.google.com:19302" }
  ]
};

async function startCamera() {
  localStream = await navigator.mediaDevices.getUserMedia({
    video: true,
    audio: true
  });
  localVideo.srcObject = localStream;
}

function createPeer() {
  peer = new RTCPeerConnection(config);

  localStream.getTracks().forEach(track => {
    peer.addTrack(track, localStream);
  });

  peer.ontrack = (event) => {
    remoteVideo.srcObject = event.streams[0];
  };

  peer.onicecandidate = (event) => {
    if (event.candidate) {
      socket.emit("signal", event.candidate);
    }
  };

  peer.onnegotiationneeded = async () => {
    try {
      makingOffer = true;
      const offer = await peer.createOffer();
      await peer.setLocalDescription(offer);
      socket.emit("signal", offer);
    } catch (err) {
      console.log("Offer error:", err);
    } finally {
      makingOffer = false;
    }
  };
}

socket.on("matched", () => {
  createPeer();
});

socket.on("signal", async (data) => {
  try {

    if (data.type === "offer") {

      const offerCollision =
        makingOffer || peer.signalingState !== "stable";

      ignoreOffer = offerCollision;

      if (ignoreOffer) return;

      await peer.setRemoteDescription(data);
      const answer = await peer.createAnswer();
      await peer.setLocalDescription(answer);
      socket.emit("signal", answer);

    } else if (data.type === "answer") {

      if (peer.signalingState !== "stable") {
        await peer.setRemoteDescription(data);
      }

    } else {

      await peer.addIceCandidate(data);

    }

  } catch (err) {
    console.log("Signal error:", err);
  }
});

socket.on("partner-disconnected", () => {
  resultText.innerText = "Stranger disconnected ğŸ˜¢";
  remoteVideo.srcObject = null;

  if (peer) {
    peer.close();
    peer = null;
  }
});

function nextMatch() {
  location.reload();
}

function checkAnswer(index) {
  if (index === 0) {
    resultText.innerText = "Correct! ğŸ‰";
  } else {
    resultText.innerText = "Wrong Answer âŒ";
  }
}

startCamera();
</script>
