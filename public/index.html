<!DOCTYPE html>
<html>
  
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Social Horaa</title>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: linear-gradient(135deg,#2b1d5f,#4e2a8e);
  color: white;
  display: flex;
  justify-content: space-between;
  align-items: center;
  min-height: 100vh;
  padding: 20px;
  box-sizing: border-box;
}

.video-box {
  width: 25%;
  height: 75vh;
  background: rgba(255,255,255,0.08);
  border-radius: 20px;
  padding: 15px;
  backdrop-filter: blur(10px);
  display: flex;
  flex-direction: column;
}

.video-box h2 {
  text-align: center;
  margin-bottom: 10px;
}

video {
  flex: 1;
  width: 100%;
  border-radius: 15px;
  object-fit: cover;
  background: black;
}

.quiz-box {
  width: 40%;
  background: rgba(255,255,255,0.08);
  padding: 25px;
  border-radius: 25px;
  text-align: center;
  backdrop-filter: blur(10px);
}

button {
  width: 100%;
  padding: 12px;
  margin: 8px 0;
  background: linear-gradient(90deg,#6a5acd,#836fff);
  color: white;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  font-size: 16px;
  transition: 0.2s;
}

button:hover {
  transform: scale(1.05);
}

.next-btn {
  margin-top: 15px;
  background: linear-gradient(90deg,#ff416c,#ff4b2b);
}

@media (max-width: 768px) {

  body {
    flex-direction: column;
    padding: 10px;
  }

  .video-box {
    width: 100%;
    height: 35vh;
    margin-bottom: 15px;
  }

  .quiz-box {
    width: 100%;
    margin-bottom: 15px;
  }
}
.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid rgba(255,255,255,0.3);
  border-top: 4px solid white;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: auto;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>

</head>

<body>

<div class="video-box">
<h2>You</h2>
<video id="localVideo" autoplay muted playsinline></video>
</div>

<div class="quiz-box">
<h1>üèÜ Social Horaa</h1>
<p id="status" style="margin-top:10px;font-weight:bold;">
üî¥ Waiting for Stranger...
</p>

<div id="loader" style="display:none;margin-top:10px;">
  <div class="spinner"></div>
  <p>Connecting...</p>
</div>

<p>What is the capital of Japan?</p>

<button onclick="checkAnswer(0)">Tokyo</button>
<button onclick="checkAnswer(1)">Seoul</button>
<button onclick="checkAnswer(2)">Beijing</button>
<button onclick="checkAnswer(3)">Bangkok</button>

<button class="next-btn" onclick="nextMatch()">Next Stranger</button>

<p id="result"></p>
</div>

<div class="video-box">
<h2>Stranger</h2>
<video id="remoteVideo" autoplay playsinline></video>
</div>

<script src="/socket.io/socket.io.js"></script>

<script>
const socket = io({
  transports: ["websocket"],
  upgrade: false
});

const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");
const resultText = document.getElementById("result");
const statusText = document.getElementById("status");
const loader = document.getElementById("loader");

let peer = null;
let localStream = null;
let pendingCandidates = [];
let makingOffer = false;
let ignoreOffer = false;
const polite = Math.random() > 0.5;

const config = {
  iceServers: [
    { urls: "stun:stun.l.google.com:19302" },

    {
      urls: "turn:openrelay.metered.ca:80?transport=tcp",
      username: "openrelayproject",
      credential: "openrelayproject"
    },
    {
      urls: "turn:openrelay.metered.ca:443?transport=tcp",
      username: "openrelayproject",
      credential: "openrelayproject"
    }
  ],
  iceTransportPolicy: "all"
};



async function startCamera() {
  try {
    localStream = await navigator.mediaDevices.getUserMedia({
      video: true,
      audio: true
    });
    localVideo.srcObject = localStream;
  } catch (err) {
    alert("Camera permission required!");
  }
}

function createPeer() {

  peer = new RTCPeerConnection(config);

  // ‚úÖ ICE STATE LISTENER (Correct position)
  peer.oniceconnectionstatechange = () => {

    console.log("ICE:", peer.iceConnectionState);

    if (peer.iceConnectionState === "checking") {
      statusText.innerText = "Establishing secure connection...";
      loader.style.display = "block";
    }

    if (peer.iceConnectionState === "connected") {
      statusText.innerText = "Connected üéâ";
      loader.style.display = "none";
    }

    if (peer.iceConnectionState === "failed") {
      statusText.innerText = "Connection Failed ‚ùå";
      loader.style.display = "none";
    }

    if (peer.iceConnectionState === "disconnected") {
      statusText.innerText = "Stranger Disconnected üò¢";
      loader.style.display = "block";
    }
  };

  localStream.getTracks().forEach(track => {
    peer.addTrack(track, localStream);
  });

  peer.ontrack = (event) => {
    remoteVideo.srcObject = event.streams[0];
  };

  peer.onicecandidate = (event) => {
    if (event.candidate) {
      socket.emit("signal", event.candidate);
    }
  };

  peer.onnegotiationneeded = async () => {
    try {
      makingOffer = true;
      const offer = await peer.createOffer();
      await peer.setLocalDescription(offer);
      socket.emit("signal", offer);
    } finally {
      makingOffer = false;
    }
  };
}

socket.on("connect", () => {
  setSearching();
});

socket.on("matched", () => {
  createPeer();
});

socket.on("signal", async (data) => {
  try {

    if (data.type === "offer") {

      if (!peer) createPeer();

      const offerCollision =
        makingOffer || peer.signalingState !== "stable";

      ignoreOffer = !polite && offerCollision;
      if (ignoreOffer) return;

      await peer.setRemoteDescription(data);

      const answer = await peer.createAnswer();
      await peer.setLocalDescription(answer);
      socket.emit("signal", answer);

    } else if (data.type === "answer") {

      if (peer.signalingState !== "stable") {
        await peer.setRemoteDescription(data);
      }

    } else {

      const candidate = new RTCIceCandidate(data);

      if (peer && peer.remoteDescription) {
        await peer.addIceCandidate(candidate);
      } else {
        pendingCandidates.push(candidate);
      }
    }

  } catch (err) {
    console.log("Signal error:", err);
  }
});

socket.on("partner-disconnected", () => {
  setDisconnected();
  remoteVideo.srcObject = null;

  if (peer) {
    peer.close();
    peer = null;
  }
});

function nextMatch() {
  setSearching();

  if (peer) {
    peer.close();
    peer = null;
  }

  remoteVideo.srcObject = null;
  socket.emit("next-stranger");
}

function checkAnswer(index) {
  resultText.innerText =
    index === 0 ? "Correct! üéâ" : "Wrong Answer ‚ùå";
}

function setSearching() {
  statusText.innerText = "Searching for stranger...";
  loader.style.display = "block";
}

function setDisconnected() {
  statusText.innerText = "Stranger disconnected üò¢";
  loader.style.display = "block";
}

startCamera();
</script>



</body>
</html>