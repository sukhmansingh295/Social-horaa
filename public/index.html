<!DOCTYPE html>
<html>
<head>
<title>Social Horaa</title>

<style>
body {
  margin:0;
  font-family: Arial, sans-serif;
  background: linear-gradient(135deg,#2b1d5f,#4e2a8e);
  color:white;
  display:flex;
  justify-content:space-between;
  align-items:center;
  height:100vh;
  padding:30px;
  box-sizing:border-box;
}

.video-box {
  width:25%;
  height:80vh;
  background: rgba(255,255,255,0.08);
  border-radius:20px;
  padding:15px;
  backdrop-filter: blur(10px);
  display:flex;
  flex-direction:column;
}

video {
  flex:1;
  width:100%;
  border-radius:15px;
  object-fit:cover;
  background:black;
}

.quiz-box {
  width:40%;
  background: rgba(255,255,255,0.08);
  padding:30px;
  border-radius:25px;
  text-align:center;
  backdrop-filter: blur(10px);
}

button {
  width:100%;
  padding:12px;
  margin:10px 0;
  background: linear-gradient(90deg,#6a5acd,#836fff);
  color:white;
  border:none;
  border-radius:12px;
  cursor:pointer;
  font-size:16px;
  transition:0.2s;
}

button:hover {
  transform:scale(1.05);
}

.next-btn {
  margin-top:20px;
  background:linear-gradient(90deg,#ff416c,#ff4b2b);
}
</style>
</head>

<body>

<div class="video-box">
<h2>You</h2>
<video id="localVideo" autoplay muted playsinline></video>
</div>

<div class="quiz-box">
<h1>üèÜ Social Horaa</h1>
<p>What is the capital of Japan?</p>

<button onclick="checkAnswer(0)">Tokyo</button>
<button onclick="checkAnswer(1)">Seoul</button>
<button onclick="checkAnswer(2)">Beijing</button>
<button onclick="checkAnswer(3)">Bangkok</button>

<button class="next-btn" onclick="nextMatch()">Next Stranger</button>

<p id="result"></p>
</div>

<div class="video-box">
<h2>Stranger</h2>
<video id="remoteVideo" autoplay playsinline></video>
</div>



<script src="/socket.io/socket.io.js"></script>

<script>
const socket = io({
  transports: ["websocket"],
  upgrade: false
});

const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");
const resultText = document.getElementById("result");

let peer;
let localStream;
let makingOffer = false;
let ignoreOffer = false;

const config = {
  iceServers: [
    { urls: "stun:stun.l.google.com:19302" }
  ]
};

async function startCamera() {
  localStream = await navigator.mediaDevices.getUserMedia({
    video: true,
    audio: true
  });
  localVideo.srcObject = localStream;
}

function createPeer() {
  peer = new RTCPeerConnection(config);

  localStream.getTracks().forEach(track => {
    peer.addTrack(track, localStream);
  });

  peer.ontrack = (event) => {
    remoteVideo.srcObject = event.streams[0];
  };

  peer.onicecandidate = (event) => {
    if (event.candidate) {
      socket.emit("signal", event.candidate);
    }
  };

  peer.onnegotiationneeded = async () => {
    try {
      makingOffer = true;
      const offer = await peer.createOffer();
      await peer.setLocalDescription(offer);
      socket.emit("signal", offer);
    } catch (err) {
      console.log("Offer error:", err);
    } finally {
      makingOffer = false;
    }
  };
}

socket.on("matched", () => {
  createPeer();
});

socket.on("signal", async (data) => {
  try {

    if (data.type === "offer") {

      const offerCollision =
        makingOffer || peer.signalingState !== "stable";

      ignoreOffer = offerCollision;

      if (ignoreOffer) return;

      await peer.setRemoteDescription(data);
      const answer = await peer.createAnswer();
      await peer.setLocalDescription(answer);
      socket.emit("signal", answer);

    } else if (data.type === "answer") {

      if (peer.signalingState !== "stable") {
        await peer.setRemoteDescription(data);
      }

    } else {

      await peer.addIceCandidate(data);

    }

  } catch (err) {
    console.log("Signal error:", err);
  }
});

socket.on("partner-disconnected", () => {
  resultText.innerText = "Stranger disconnected üò¢";
  remoteVideo.srcObject = null;

  if (peer) {
    peer.close();
    peer = null;
  }
});

function nextMatch() {
  location.reload();
}

function checkAnswer(index) {
  if (index === 0) {
    resultText.innerText = "Correct! üéâ";
  } else {
    resultText.innerText = "Wrong Answer ‚ùå";
  }
}

startCamera();
</script>
</body>
</html>