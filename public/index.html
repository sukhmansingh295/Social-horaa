<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Social Horaa</title>

<style>
body {
  margin:0;
  font-family: Arial;
  background: linear-gradient(135deg,#2b1d5f,#4e2a8e);
  color:white;
  display:flex;
  justify-content:space-between;
  align-items:center;
  min-height:100vh;
  padding:20px;
  box-sizing:border-box;
}

.video-box {
  width:25%;
  height:70vh;
  background:rgba(255,255,255,0.08);
  border-radius:20px;
  padding:15px;
  display:flex;
  flex-direction:column;
}

video {
  flex:1;
  width:100%;
  border-radius:15px;
  object-fit:cover;
  background:black;
}

.quiz-box {
  width:40%;
  background:rgba(255,255,255,0.08);
  padding:25px;
  border-radius:25px;
  text-align:center;
}

button {
  width:100%;
  padding:12px;
  margin:8px 0;
  background:#6a5acd;
  color:white;
  border:none;
  border-radius:12px;
  cursor:pointer;
}

.next-btn {
  background:#ff416c;
}

.spinner {
  width:40px;
  height:40px;
  border:4px solid rgba(255,255,255,0.3);
  border-top:4px solid white;
  border-radius:50%;
  animation:spin 1s linear infinite;
  margin:auto;
}

@keyframes spin {
  0%{transform:rotate(0deg);}
  100%{transform:rotate(360deg);}
}
</style>
</head>

<body>

<div class="video-box">
<h3>You</h3>
<video id="localVideo" autoplay muted playsinline></video>
</div>

<div class="quiz-box">

  <h2>üß† Quiz Battle</h2>

<p id="questionText">Waiting for question...</p>


<button id="readyBtn" onclick="sendReady()" 
style="background:#00c853;font-weight:bold;">
READY
</button>

<p id="readyStatus"></p>


<div id="options">
  <button id="btn0" onclick="sendAnswer(0)">Option 1</button>
  <button id="btn1" onclick="sendAnswer(1)">Option 2</button>
  <button id="btn2" onclick="sendAnswer(2)">Option 3</button>
  <button id="btn3" onclick="sendAnswer(3)">Option 4</button>
</div>

<p id="timer">Time: 10</p>
<p id="score">Your Score: 0</p>

<h2>üèÜ Social Horaa</h2>
<p id="status">Searching for stranger...</p>
<div id="loader"><div class="spinner"></div></div>

<button class="next-btn" onclick="nextMatch()">Next Stranger</button>
</div>

<div class="video-box">
<h3>Stranger</h3>
<video id="remoteVideo" autoplay playsinline></video>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>

const socket = io({
  transports: ["websocket"],
  reconnection: true,
  reconnectionAttempts: Infinity,
  reconnectionDelay: 1000,
  reconnectionDelayMax: 5000,
  timeout: 20000
});

const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");
const statusText = document.getElementById("status");
const loader = document.getElementById("loader");

let peer = null;
let localStream = null;
let reconnecting = false;


const config = {
  iceServers: [
    { urls: "stun:stun.l.google.com:19302" },
    {
      urls: [
        "turn:openrelay.metered.ca:80?transport=tcp",
        "turn:openrelay.metered.ca:443?transport=tcp"
      ],
      username: "openrelayproject",
      credential: "openrelayproject"
    }
  ]
};

async function startCamera() {
  if (!localStream) {
    localStream = await navigator.mediaDevices.getUserMedia({
      video: true,
      audio: true
    });
    localVideo.srcObject = localStream;
  }
}

function createPeer() {

  peer = new RTCPeerConnection(config);

  localStream.getTracks().forEach(track => {
    peer.addTrack(track, localStream);
  });

  peer.ontrack = (e) => {
    remoteVideo.srcObject = e.streams[0];
  };

  peer.onicecandidate = (e) => {
    if (e.candidate) {
      socket.emit("signal", e.candidate);
    }
  };

  peer.oniceconnectionstatechange = () => {

    console.log("ICE:", peer.iceConnectionState);

    if (peer.iceConnectionState === "checking") {
      statusText.innerText = "Connecting...";
      loader.style.display = "block";
    }

    if (peer.iceConnectionState === "connected") {
      statusText.innerText = "Connected üéâ";
      loader.style.display = "none";
    }

    if (peer.iceConnectionState === "failed") {
      console.log("ICE Restarting...");
      peer.restartIce();
    }

    if (peer.iceConnectionState === "disconnected") {
      statusText.innerText = "Reconnecting...";
      loader.style.display = "block";
      safeReconnect();
    }
  };
}

function destroyPeer() {
  if (peer) {
    peer.ontrack = null;
    peer.onicecandidate = null;
    peer.close();
    peer = null;
  }
  remoteVideo.srcObject = null;
}

function safeReconnect() {

  if (reconnecting) return;
  reconnecting = true;

  destroyPeer();

  setTimeout(() => {
    socket.emit("next-stranger");
    reconnecting = false;
  }, 1000);
}

/* ---------------- SOCKET EVENTS ---------------- */

socket.on("connect", () => {
  console.log("Socket connected:", socket.id);
  statusText.innerText = "Searching...";
  loader.style.display = "block";
});

socket.on("disconnect", () => {
  console.log("Socket disconnected");
  statusText.innerText = "Reconnecting to server...";
  loader.style.display = "block";
});

socket.on("reconnect", () => {
  console.log("Socket reconnected");
  statusText.innerText = "Searching again...";
  loader.style.display = "block";
  socket.emit("next-stranger");
});

socket.on("matched", async (data) => {

  await startCamera();
  createPeer();

  if (data.initiator) {
    const offer = await peer.createOffer();
    await peer.setLocalDescription(offer);
    socket.emit("signal", offer);
  }
});

socket.on("signal", async (data) => {
  try {

    if (!peer) createPeer();

    if (data.type === "offer") {

      await peer.setRemoteDescription(new RTCSessionDescription(data));
      const answer = await peer.createAnswer();
      await peer.setLocalDescription(answer);
      socket.emit("signal", answer);

    } else if (data.type === "answer") {

      await peer.setRemoteDescription(new RTCSessionDescription(data));

    } else {

      await peer.addIceCandidate(new RTCIceCandidate(data));
    }

  } catch (err) {
    console.log("Signal error:", err);
  }
});

socket.on("partner-disconnected", () => {
  statusText.innerText = "Stranger left. Searching again...";
  loader.style.display = "block";
  destroyPeer();

  setTimeout(() => {
    socket.emit("next-stranger");
  }, 1000);

  isReady = false;
document.getElementById("readyBtn").disabled = false;
document.getElementById("readyBtn").innerText = "READY";
document.getElementById("readyBtn").style.display = "block";


});

/* ---------------- QUIZ SYSTEM ---------------- */
let isReady = false;
let timerInterval = null;
let timeLeft = 10;
let answered = false;

socket.on("quiz-question", (data) => {

  answered = false;
  timeLeft = data.duration;

  document.getElementById("questionText").innerText = data.question;

  data.options.forEach((opt, i) => {
    const btn = document.getElementById("btn" + i);
    btn.innerText = opt;
    btn.disabled = false;
    btn.style.background = "#6a5acd";
  });

  startTimer(data.duration);
});

function sendReady() {

  if (isReady) return;

  isReady = true;

  document.getElementById("readyBtn").disabled = true;
  document.getElementById("readyBtn").innerText = "Waiting for opponent...";
  
  socket.emit("player-ready");
}


function startTimer(duration) {

  clearInterval(timerInterval);
  timeLeft = duration;

  document.getElementById("timer").innerText =
    "Time: " + timeLeft;

  timerInterval = setInterval(() => {

    timeLeft--;

    document.getElementById("timer").innerText =
      "Time: " + timeLeft;

    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      disableOptions();
    }

  }, 1000);
}

function sendAnswer(index) {

  if (answered) return;

  answered = true;

  highlightSelected(index);

  socket.emit("quiz-answer", index);

  disableOptions();
}

function disableOptions() {
  for (let i = 0; i < 4; i++) {
    document.getElementById("btn" + i).disabled = true;
  }
}

function highlightSelected(index) {
  document.getElementById("btn" + index).style.background = "#00c853";
}


socket.on("both-ready", () => {

  document.getElementById("readyStatus").innerText =
    "Both players ready! Quiz starting...";

  setTimeout(() => {
    document.getElementById("readyBtn").style.display = "none";
  }, 1000);
});




socket.on("quiz-result", (data) => {

  clearInterval(timerInterval);

  disableOptions();

  document.getElementById("btn" + data.correctAnswer)
    .style.background = "#00c853";

  document.getElementById("score").innerText =
    "Your Score: " + data.score;
});

socket.on("quiz-end", (data) => {

  clearInterval(timerInterval);

  let message;

  if (!data.winner) {
    message = "ü§ù Draw!";
  } else if (data.winner === socket.id) {
    message = "üèÜ You Win!";
  } else {
    message = "üò¢ You Lost!";
  }

  alert(
    message +
    "\nYour Score: " + data.yourScore +
    "\nOpponent Score: " + data.opponentScore
  );

  socket.emit("next-stranger");
});


/* ---------------- BUTTON ---------------- */

function nextMatch() {

  statusText.innerText = "Searching...";
  loader.style.display = "block";

  destroyPeer();
  socket.emit("next-stranger");
}

startCamera();

</script>

</body>
</html>
